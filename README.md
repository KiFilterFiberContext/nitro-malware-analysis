# Discord Nitro Malware Analysis
Taking a break from Codebreaker and other CTFs I decided to look around for dumb malware samples to analyze.  
I looked around for malware masquerading as legitimate software on YouTube and discovered something somewhat [interesting](https://www.mediafire.com/file/z3j00lgl999e5a0/Discord_Nitro_Generator_v2.zip/file).

There are many variants of the bot being distributed through password-protected ZIP files on file hosting services through YouTube.  All of them pretend to be a legitimate program for whatever purpose it may serve.  

## Zip Overview
- `Discord Nitro Generator v2.exe`
  - SHA256: `59943df31a112848cb7ab23034fc67b6df7a91735462ab13cdd8d739f8ec91c5`
  - MD5: `f725296d6722b4d6096feacf76285bb0`
 
- `generator.dll`
  - SHA256: `d8969ace98532dc895616847fedbb9b2a4fcb21e660de3a42689da0a1924fdb6`
  - MD5: `d75237337798a67147768480343f6cd4`
 
- `sysle.dll`
  - SHA256: `0e75587c7cbab7dedd1564cd8dcaa149d95faffa1ec49f209069cfbcd07894cf`
  - MD5: `3b1b6b6f002fb6f4e8c803ad12b76694`

Ironically, the two bundled dlls are not used in any way by the malware.

The first, `generator.dll`, is a legitimate library renamed from `nss3.dll`, which contains a digital certificate from Mozilla.  The second, `sysle.dll`, appears to be a library related to some game and is signed with digital certificate belonging to "Chistyj Znak".

![image](https://user-images.githubusercontent.com/51222153/139795264-5417021c-5bdd-4661-8836-527a735721db.png)

## Initial Analysis
The dropper is a 32bit .NET PE binary which is mildly obfuscated.  The sample relies on obnoxious opaque predicates in the form of constant square root evaluations and mangled method names.  Surprisingly, there is no string encryption or other forms of obfuscation present, but it becomes very clear as the malware makes no distinct effort to appear legitimate to its user (or be original at all).  

One thing to note is that there is a signature present in the file referencing the PulsarCrypter bot family used in these fake programs.

![image](https://user-images.githubusercontent.com/51222153/139797894-799adc24-3229-475b-943c-655f04921c1c.png)

There is an 105472-byte resource acting as an encrypted PE file.  The resource will be decrypted by the malware using the hardcoded XOR key: `AqsBVszDcWc`.

![image](https://user-images.githubusercontent.com/51222153/139796926-87bc5e1e-bff2-4866-82ee-44a9b0258640.png)

The malware will first resolve various exports from `kernel32.dll` and then proceed to inject the decrypted payload into a spawned `RegAsm.exe` process by hijacking its thread context.

![image](https://user-images.githubusercontent.com/51222153/139797794-76bc6c4c-304b-479c-8077-a2cde19e5c44.png)

## Analyzing the malware
- SHA256: `1bb94f1a163a4e8b92efdfaa6ba53a4b9d563d0f15f8dd9f3a56819ed06aba46`
- MD5: `a9c0c7baaa6dda43f9600ab8fa113083`

The first-stage malware is responsible for communicating with the C2 server and uploading user information.  The .NET malware is obfuscated with vanilla Eazfuscator, but it can be easily defeated with de4dot.

 The malware will first check for the presence of `rdpclip.exe` and common VM vendor brands using WMI queries against the following list: `virtual`, `vmbox`, `vmware`, `virtualbox`, `vbox`, `redhat`, `windowsserver`.  Afterward, it will retrieve a configuration file containing the download link for the second-stage malware.  Running `whois` on the IP address reveals that the actor group is located in Russia.

![image](https://user-images.githubusercontent.com/51222153/139800243-4f342ea4-1555-47a0-9916-46027f96c760.png)

After initialization, the malware will attempt to establish a connection to each of the present C2 addresses. IP addresses and IDs for the C2 are base64 encoded and encrypted with the hardcoded XOR key: `Skepticism`.

![image](https://user-images.githubusercontent.com/51222153/139801097-f6c31739-a3f6-4348-8049-4275e34202ad.png)

The client will start a handshake with the C2 server by sending a HTTP request containing a `Authorization` header with the following hardcoded value: `cdf3919a262c0d6ba99116b375d7551c`.  It will then decrypt the client ID and begin sending information about the host to the C2 server.  The malware determines what information to transmit depending on the version.  There are only two versions available at the time of writing.  

![image](https://user-images.githubusercontent.com/51222153/139806372-98db12fa-7b11-467b-9628-b0e37b7b2094.png)

There are two action classifications for each piece of information.
The actions include: 

| Type  | Information | 
| ------ | ------------ |
| PreAction | Username | 
| PreAction | Monitor Size |
| PreAction | Windows Version | 
| PreAction | Process Directory | 
| PreAction | Info Hash `md5(DomainName + UserName + Serial)` |
| PreAction | Timezone |
| Action | Processors and Graphic Cards |
| Action | Browsers Profiles |
| Action | Installed Programs |
| Action | FireZilla credentials |
| Action | BrEx wallet credentials |
| Action | Discord tokens |
| Action | Steam Games |
| Action | VPNs (NordVPN, OpenVPN) |

After uploading the information to the C2 it will receive a list of tasks to complete.
There are three tasks for downloading files, executing files, and updating the malware.  From there, it will continue running in a while loop.

# Analyzing the second-stage malware
As mentioned previously, the malware will download another implant from the web server and drop it in the infected user's AppData directory.  The actors appear to use Discord as means for hosting their second-stage malware.

![image](https://user-images.githubusercontent.com/51222153/140252178-6deb67ec-a251-45e1-bdb2-75c014bf0fd4.png)

The initial download is a self-extracting RAR archive, that, once decompressed, will reveal another .NET binary named `Autocarpian.exe`.  The binary is obfuscated with Eazfuscator.  Dropping the binary in ILspy will yield a `System.BadImageFormatException` and de4dot will not work on it due to invalid CLR metadata.  

